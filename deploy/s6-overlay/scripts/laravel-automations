#!/command/with-contenv bash

# Define color codes
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[0;33m"
RESET="\033[0m"

# Exit on error
set -e

echo ""
echo "âš™ï¸  Setting up Slipstream..."
echo ""

# Fix permissions
echo "ğŸ”’ Fixing app path file permissions..."
chmod -R 755 $WEBUSER_HOME/data
chown -R webuser:webgroup $WEBUSER_HOME/data
echo "âœ…  Permissions fixed."

# Check for env file
if [ ! -f $WEBUSER_HOME/data/.env ]; then
    echo "ğŸ™„  Environment file not found, creating..."
    s6-setuidgid webuser cp $WEBUSER_HOME/.env.example $WEBUSER_HOME/data/.env
    echo "âœ…  Environment file created."
else
    echo "âœ…  Environment file exists."
fi

# Symlinks
echo "ğŸ”—ï¸ Making symlinks..."
if [ ! -f $WEBUSER_HOME/.env ]; then
    ln -s $WEBUSER_HOME/data/.env $WEBUSER_HOME/.env
fi

 if [ -d $WEBUSER_HOME/public/storage ]; then
    echo "âœ… Storage already linked..."
else
    echo "ğŸ” Linking the storage..."
    s6-setuidgid webuser php $WEBUSER_HOME/artisan storage:link
fi

# Migrations
echo "ğŸš€ Running migrations..."
s6-setuidgid webuser php $WEBUSER_HOME/artisan migrate --force --isolated

# App key
if grep -E "APP_KEY=[0-9A-Za-z:+\/=]{1,}" $WEBUSER_HOME/.env > /dev/null; then
    echo "âœ…  App key exists"
else
    echo "â³  Generating app key..."
    s6-setuidgid webuser php $WEBUSER_HOME/artisan key:generate --no-ansi -q
    echo "âœ…  App key generated."
fi

s6-setuidgid webuser echo "ğŸŸ¢ Running PHP $(php -v | grep ^PHP | cut -d' ' -f2)"
s6-setuidgid webuser echo "ğŸŸ¢ Running Node $(node -v)"
s6-setuidgid webuser echo "ğŸŸ¢ Running NPM $(npm -v)"

echo ""

# Starting Soketi
echo "ğŸ•› Starting Soketi (Websockets)"
s6-setuidgid webuser soketi start &

echo "-------------------------------------"
echo -e "${GREEN}ğŸ Slipstream configured.${RESET}"
echo "-------------------------------------"

exit 0
